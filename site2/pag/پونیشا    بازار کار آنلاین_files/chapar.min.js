var base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}};var chapar={traceDump:false,trace:function(e,t,n){if(this.traceDump){if(n){if(t){console.error(e,t)}else{console.error(e)}}else{if(t){console.log(e,t)}else{console.log(e)}}}},getSize:function(e){var t=0;for(var n in e){if(e.hasOwnProperty(n)){++t}}return t},socket:{status:false,online:false,onListener:{},statusChecker:null,statusCheckerInterval:1e4,echoSrv:null,sessionId:null,uId:null,room:null,attr:null,sock:null,init:function(e,t,n,r,i){this.echoSrv=e;this.sessionId=t;this.uId=n;this.room=r;this.attr=i?i:""},isConnected:function(){return chapar.socket.status},isOnline:function(){return chapar.socket.online},addListener:function(e,t){if(!(e in this.onListener)){this.onListener[e]={}}this.onListener[e][chapar.getSize(this.onListener[e])]=t},callListener:function(e,t){try{for(var n in this.onListener[e]){chapar.trace("call listener["+n+"]",e);this.onListener[e][n](t)}}catch(r){chapar.trace("call listener exception "+e,r,true)}},connect:function(){chapar.socket.disconnect();this.sock=new SockJS(this.echoSrv);this.sock.onopen=function(){chapar.socket.status=true;chapar.socket.callListener("onConnect");chapar.trace("open")};this.sock.onmessage=function(e){message=JSON.parse(e.data);if("emit"in message){var t=message.message;chapar.socket.callListener("onBeforeEmit",t);switch(message.emit){case"welcome":chapar.socket.emit("greating",{wReqSockId:t.introduce,wReqSessId:chapar.socket.sessionId,wReqUId:chapar.socket.uId,wReqIp:t.ip,wReqRoom:chapar.socket.room,wReqAttr:chapar.socket.attr,wReqDate:Date.now()});break;case"niceToMeetYou":chapar.socket.online=true;chapar.socket.callListener("onOnline");break;case"doRefresh":if(t.after==0){location.reload()}else{setTimeout(function(){location.reload()},t.after)}break;case"trigger":try{if(chapar.trigger.isCallable(t.trigger)){chapar.trace("trigger call '"+t.trigger+"'",t);if(typeof t.params=="object"){chapar.trigger.fire(t.trigger,t.params)}else{var n=base64.decode(t.params);n=JSON.parse(n);chapar.trigger.fire(t.trigger,n)}}else{chapar.trace("trigger failed '"+t.trigger+"'",t,true)}}catch(r){chapar.trace("trigger exeption '"+t.trigger+"'",r,true)}break;case"wrongEmit":chapar.trace("wrong Emit Call",t,true);break}chapar.socket.callListener("onMessage",t)}else{chapar.trace("emit failed",message)}};this.sock.onclose=function(){chapar.socket.status=false;chapar.socket.online=false;chapar.socket.callListener("onDisconnect");chapar.trace("close")};if(chapar.socket.statusChecker==null){chapar.socket.statusChecker=setInterval(function(){chapar.trace("check connection");chapar.socket.callListener("onCkeckConnection");if(!chapar.socket.isConnected()){chapar.socket.disconnect();setTimeout(function(){chapar.socket.sock=null;chapar.socket.connect()},1e3)}},chapar.socket.statusCheckerInterval)}},send:function(e){if(this.status){this.sock.send(e)}},emit:function(e,t){chapar.socket.send(JSON.stringify({emit:e,message:t}))},disconnect:function(){if(this.sock){this.sock.close()}}},trigger:{barn:[],fire:function(e,t){try{for(var n in this.barn[e]){chapar.trace("trigger fire["+n+"]",e);this.barn[e][n](t)}}catch(r){chapar.trace("trigger fire exception"+e,t)}},isCallable:function(e){return this.barn.hasOwnProperty(e)},push:function(e,t){if(!(e in this.barn)){this.barn[e]={}}this.barn[e][chapar.getSize(this.barn[e])]=t},slice:function(e){delete this.barn[e]},dump:function(e){return this.barn}},users:{onlineCount:null,onlineList:{},setOnlineCount:function(e){this.onlineCount=e},setOnlineList:function(e){this.onlineList=e},getOnlineCount:function(e){return this.onlineCount},getOnlineList:function(e){return this.onlineList},isUserOnline:function(e){var t=false;for(var n in this.onlineList){if(parseInt(this.onlineList[n].uid)==parseInt(e)){t=this.onlineList[n]}}return t},onlineDump:function(e){return[this.onlineCount,this.onlineList]},checkOnlineListener:function(e,t,n){try{e.each(function(e,r){var i=chapar.users.isUserOnline($(r).attr("uid"));if(i){t($(r),i)}else{n($(r))}})}catch(r){chapar.trace("checkOnlineListener exception ",r,true)}}}}